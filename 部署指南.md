# 个人网盘系统部署指南

## 系统功能特点

✅ **核心功能**
- 文件上传和下载
- 文件夹上传支持
- 在线文件管理
- 拖拽上传
- 进度显示
- 文件删除

✅ **界面特点**
- 现代化响应式设计
- 支持移动端
- 直观的文件管理界面
- 实时操作反馈

✅ **技术特点**
- Flask后端 + HTML/CSS/JS前端
- Nginx反向代理
- Systemd服务管理
- 支持大文件上传（最大16GB）

## 快速部署（推荐）

### 方法一：自动部署脚本

1. **上传文件到服务器**
```bash
# 将所有文件上传到服务器的某个目录，例如 /tmp/netdisk
scp -r ./* root@your-server-ip:/tmp/netdisk/
```

2. **运行自动部署脚本**
```bash
# 连接到服务器
ssh root@your-server-ip

# 进入部署目录
cd /tmp/netdisk

# 给脚本执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

3. **访问系统**
```
部署完成后，打开浏览器访问：http://your-server-ip
```

## 手动部署

如果自动部署脚本遇到问题，可以按以下步骤手动部署：

### 步骤1：准备服务器环境

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip python3-venv nginx ufw
```

### 步骤2：创建应用目录

```bash
# 创建应用目录
sudo mkdir -p /opt/netdisk
sudo mkdir -p /var/log/netdisk
sudo mkdir -p /opt/netdisk/uploads

# 创建用户
sudo useradd -r -s /bin/false www-data 2>/dev/null || true
```

### 步骤3：部署应用文件

```bash
# 复制应用文件
sudo cp app.py /opt/netdisk/
sudo cp requirements.txt /opt/netdisk/
sudo cp gunicorn_config.py /opt/netdisk/

# 设置权限
sudo chown -R www-data:www-data /opt/netdisk
sudo chown -R www-data:www-data /var/log/netdisk
sudo chmod -R 755 /opt/netdisk
```

### 步骤4：配置Python环境

```bash
# 进入应用目录
cd /opt/netdisk

# 创建虚拟环境
sudo -u www-data python3 -m venv venv

# 激活虚拟环境并安装依赖
sudo -u www-data /opt/netdisk/venv/bin/pip install --upgrade pip
sudo -u www-data /opt/netdisk/venv/bin/pip install -r requirements.txt
```

### 步骤5：配置Systemd服务

```bash
# 复制服务文件
sudo cp netdisk.service /etc/systemd/system/

# 重载systemd并启用服务
sudo systemctl daemon-reload
sudo systemctl enable netdisk.service
sudo systemctl start netdisk.service

# 检查服务状态
sudo systemctl status netdisk.service
```

### 步骤6：配置Nginx

```bash
# 复制Nginx配置
sudo cp nginx.conf /etc/nginx/sites-available/netdisk

# 启用站点
sudo ln -sf /etc/nginx/sites-available/netdisk /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 步骤7：配置防火墙

```bash
# 启用防火墙
sudo ufw --force enable

# 允许SSH和HTTP/HTTPS
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'

# 查看防火墙状态
sudo ufw status
```

## 配置域名和HTTPS（可选）

### 配置域名

1. **修改Nginx配置**
```bash
sudo nano /etc/nginx/sites-available/netdisk
```

2. **将 `your-domain.com` 替换为你的实际域名**

3. **重启Nginx**
```bash
sudo systemctl restart nginx
```

### 配置HTTPS（使用Let's Encrypt）

```bash
# 安装certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

## 系统管理

### 服务管理命令

```bash
# 启动服务
sudo systemctl start netdisk.service

# 停止服务
sudo systemctl stop netdisk.service

# 重启服务
sudo systemctl restart netdisk.service

# 查看服务状态
sudo systemctl status netdisk.service

# 查看实时日志
sudo journalctl -u netdisk.service -f
```

### 日志管理

```bash
# 查看应用日志
sudo tail -f /var/log/netdisk/error.log
sudo tail -f /var/log/netdisk/access.log

# 查看Nginx日志
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

### 文件管理

- **上传目录**：`/opt/netdisk/uploads`
- **应用代码**：`/opt/netdisk/app.py`
- **配置文件**：`/opt/netdisk/gunicorn_config.py`

### 性能优化

1. **调整上传限制**
```bash
# 编辑Nginx配置
sudo nano /etc/nginx/sites-available/netdisk
# 修改 client_max_body_size 值

# 编辑应用配置
sudo nano /opt/netdisk/app.py
# 修改 MAX_CONTENT_LENGTH 值
```

2. **调整工作进程数**
```bash
# 编辑Gunicorn配置
sudo nano /opt/netdisk/gunicorn_config.py
# 修改 workers 数量（建议为CPU核心数 × 2）
```

## 故障排除

### 常见问题

1. **服务无法启动**
```bash
# 检查日志
sudo journalctl -u netdisk.service --no-pager
# 检查Python环境
sudo -u www-data /opt/netdisk/venv/bin/python3 /opt/netdisk/app.py
```

2. **无法访问网站**
```bash
# 检查Nginx状态
sudo systemctl status nginx
# 检查防火墙
sudo ufw status
# 检查端口占用
sudo netstat -tulpn | grep :80
```

3. **上传失败**
```bash
# 检查目录权限
ls -la /opt/netdisk/uploads
# 检查磁盘空间
df -h
```

4. **权限问题**
```bash
# 重新设置权限
sudo chown -R www-data:www-data /opt/netdisk
sudo chmod -R 755 /opt/netdisk
```

### 卸载系统

```bash
# 停止服务
sudo systemctl stop netdisk.service
sudo systemctl disable netdisk.service

# 删除服务文件
sudo rm /etc/systemd/system/netdisk.service
sudo systemctl daemon-reload

# 删除Nginx配置
sudo rm /etc/nginx/sites-available/netdisk
sudo rm /etc/nginx/sites-enabled/netdisk

# 删除应用文件
sudo rm -rf /opt/netdisk
sudo rm -rf /var/log/netdisk

# 重启Nginx
sudo systemctl restart nginx
```

## 安全建议

1. **定期备份**
```bash
# 备份上传文件
sudo tar -czf netdisk-backup-$(date +%Y%m%d).tar.gz /opt/netdisk/uploads
```

2. **访问控制**
- 考虑添加用户认证
- 配置IP白名单
- 使用HTTPS加密传输

3. **系统监控**
- 监控磁盘使用情况
- 定期查看访问日志
- 设置文件大小限制

## 技术支持

如果遇到问题，请检查：
1. 系统日志：`sudo journalctl -u netdisk.service`
2. 应用日志：`/var/log/netdisk/error.log`
3. Nginx日志：`/var/log/nginx/error.log`

记录错误信息以便进一步排查问题。
